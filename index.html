<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cover Letter Updater</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/babel-standalone@6.26.0/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect } = React
      const md = window.markdownit()
      const { jsPDF } = window.jspdf

      function App() {
        const [company, setCompany] = useState('')
        const [position, setPosition] = useState('')
        const [companyAddress, setCompanyAddress] = useState('')
        const [date, setDate] = useState(
          new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })
        )
        const [template, setTemplate] = useState('')
        const [fontLoaded, setFontLoaded] = useState(false)
        const [isLoading, setIsLoading] = useState(false)

        // Load Markdown template
        useEffect(() => {
          fetch('/cover_letter.md')
            .then((response) => response.text())
            .then((text) => setTemplate(text))
            .catch((error) => console.error('Error loading template:', error))
        }, [])

        // Load custom font (Roboto Regular) with fallback
        useEffect(() => {
          const loadFont = async () => {
            try {
              const response = await fetch(
                'https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu4mxKKTU1Kg.ttf'
              ) // Changed to .ttf for jsPDF compatibility
              if (!response.ok) throw new Error('Font fetch failed')
              const fontData = await response.arrayBuffer()
              const fontBytes = new Uint8Array(fontData)
              const base64Font = btoa(String.fromCharCode(...fontBytes))
              const doc = new jsPDF()
              doc.addFileToVFS('Roboto-Regular.ttf', base64Font)
              doc.addFont('Roboto-Regular.ttf', 'Roboto', 'normal')
              setFontLoaded(true)
            } catch (error) {
              console.error('Error loading font:', error)
              setFontLoaded(true) // Proceed with default font
            }
          }
          loadFont()
        }, [])

        // Custom function to justify text only for near-full-width lines
        const justifyText = (doc, text, x, y, maxWidth, fontSize, lineSpacing) => {
          const lines = doc.splitTextToSize(text, maxWidth)
          const justificationThreshold = maxWidth * 0.8 // Justify if line width is at least 80% of maxWidth
          lines.forEach((line) => {
            if (y > 272) {
              // A4 height (297mm) - bottom margin
              doc.addPage()
              y = 25 // Reset to top margin
            }
            const words = line.trim().split(/\s+/)
            if (words.length <= 1) {
              // Single word or empty line: use left alignment
              doc.text(line, x, y)
            } else {
              // Calculate total width of words
              const wordWidths = words.map((word) => doc.getTextWidth(word))
              const totalWordWidth = wordWidths.reduce((sum, width) => sum + width, 0)
              if (totalWordWidth >= justificationThreshold) {
                // Justify near-full-width lines
                const spaceCount = words.length - 1
                const spaceWidth = (maxWidth - totalWordWidth) / spaceCount
                let currentX = x
                words.forEach((word, i) => {
                  doc.text(word, currentX, y)
                  currentX += wordWidths[i] + spaceWidth
                })
              } else {
                // Left-align lines that are too short
                doc.text(line, x, y)
              }
            }
            y += lineSpacing
          })
          return y // Return updated y position
        }

        // Handle form submission
        const handleUpdate = () => {
          if (!fontLoaded) {
            setIsLoading(true)
            alert('Font is still loading. Please try again in a moment.')
            return
          }
          setIsLoading(true)

          // Replace placeholders
          let updatedContent = template
            .replaceAll('{{company}}', company || 'Your Company')
            .replaceAll('{{position}}', position || 'Your Position')
            .replaceAll('{{companyAddress}}', companyAddress || '')
            .replaceAll(
              '{{date}}',
              date ||
                new Date().toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                })
            )

          // Generate PDF with proper layout
          const doc = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4',
          })
          const margin = 25 // 25mm margins
          const pageWidth = 210 // A4 width in mm
          const maxWidth = pageWidth - 2 * margin // Usable width
          doc.setFont(fontLoaded ? 'Roboto' : 'times', 'normal')
          doc.setFontSize(12)
          justifyText(doc, updatedContent, margin, margin, maxWidth, 12, 5)
          doc.save('cover-letter.pdf')
          setIsLoading(false)
        }

        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center">
            <div className="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
              <h1 className="text-2xl font-bold mb-6 text-center">Cover Letter Updater</h1>
              <div className="mb-4">
                <label className="block text-gray-700 mb-2" htmlFor="company">
                  Company Name
                </label>
                <input
                  id="company"
                  type="text"
                  value={company}
                  onChange={(e) => setCompany(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Enter company name"
                />
              </div>
              <div className="mb-6">
                <label className="block text-gray-700 mb-2" htmlFor="position">
                  Position
                </label>
                <input
                  id="position"
                  type="text"
                  value={position}
                  onChange={(e) => setPosition(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Enter position"
                />
              </div>
              <div className="mb-6">
                <label className="block text-gray-700 mb-2" htmlFor="companyAddress">
                  Company Address (optional)
                </label>
                <input
                  id="companyAddress"
                  type="text"
                  value={companyAddress}
                  onChange={(e) => setCompanyAddress(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Enter company address"
                />
              </div>
              <button
                onClick={handleUpdate}
                disabled={isLoading}
                className={`w-full py-2 rounded-lg transition duration-200 ${
                  isLoading
                    ? 'bg-gray-400 cursor-not-allowed'
                    : 'bg-blue-500 hover:bg-blue-600 text-white'
                }`}
              >
                {isLoading ? 'Generating PDF...' : 'Update & Download PDF'}
              </button>
            </div>
          </div>
        )
      }

      ReactDOM.render(<App />, document.getElementById('root'))
    </script>
  </body>
</html>
